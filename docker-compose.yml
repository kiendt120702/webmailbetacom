services:
  # =============================================================
  # iRedMail - All-in-one Mail Server (includes Nginx inside)
  # =============================================================
  iredmail:
    image: iredmail/mariadb:stable
    container_name: iredmail
    hostname: ${MAIL_HOSTNAME}

    env_file:
      - iredmail-docker.conf

    environment:
      - TZ=${TIMEZONE}

    ports:
      - "80:80"       # HTTP (redirect to HTTPS)
      - "443:443"     # HTTPS (Webmail)
      - "25:25"       # SMTP
      - "587:587"     # Submission (STARTTLS)
      - "465:465"     # SMTPS
      - "993:993"     # IMAPS
      - "995:995"     # POP3S
      - "110:110"     # POP3
      - "143:143"     # IMAP

    volumes:
      # Mailbox storage
      - ./data/mailboxes:/var/vmail/vmail1
      - iredmail_mlmmj:/var/vmail/mlmmj
      - iredmail_mlmmj_archive:/var/vmail/mlmmj-archive

      # Database
      - ./data/mysql:/var/lib/mysql

      # Backups
      - ./data/backup:/var/vmail/backup

      # SSL certificates
      - ./data/ssl:/opt/iredmail/ssl

      # Antivirus & spam
      - iredmail_clamav:/var/lib/clamav
      - iredmail_sa_rules:/var/lib/spamassassin

      # Mail queue
      - iredmail_postfix_queue:/var/spool/postfix

      # Custom configurations
      - iredmail_custom:/opt/iredmail/custom

    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1/iredadmin/"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 180s

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

# =============================================================
# Named Volumes
# =============================================================
volumes:
  iredmail_mlmmj:
    driver: local
  iredmail_mlmmj_archive:
    driver: local
  iredmail_clamav:
    driver: local
  iredmail_sa_rules:
    driver: local
  iredmail_postfix_queue:
    driver: local
  iredmail_custom:
    driver: local
